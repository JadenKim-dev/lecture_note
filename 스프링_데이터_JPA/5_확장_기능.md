### 사용자 정의 레포지토리 구현

스프링 데이터 JPA는 기본적으로 인터페이스로 정의된 레포지토리를 사용한다.  
그렇기 때문에 해당 인터페이스를 직접 구현하면 인터페이스 내의 모든 메서드를 구현해야 한다.  
하지만 일부의 메서드에 한해서만 Querydsl, MyBatis 등의 다른 기술을 사용하여 직접 구현할 필요가 있을 수 있다.

이를 위해서 먼저 커스텀 메서드를 정의하는 인터페이스를 별도로 정의한다.

```java
public interface MemberRepositoryCustom {
    List<Member> findMemberCustom();
}
```

그리고 레포지토리 구현체에서 원하는 기술을 사용하여 해당 인터페이스를 구현한다.  
아래 예시에서는 순수한 JPA를 이용해서 findMemberCustom 메서드를 구현했다.  
다만 이 때 구현체의 이름은 `스프링 데이터 JPA 레포지토리 이름 + Impl` 형태여야 한다.

```java
@RequiredArgsConstructor
public class MemberRepositoryImpl implements MemberRepositoryCustom {

    private final EntityManager em;

    @Override
    public List<Member> findMemberCustom() {
        return em.createQuery("select m from Member m")
                .getResultList();
    }
}
```

그 후에 다음과 같이 스프링 데이터 JPA 레포지토리가 앞에서 정의했던 커스텀 인터페이스를 상속하도록 추가하면 된다.  
이렇게만 추가해두면 스프링 데이터 JPA는 `레포지토리 이름 + Impl` 이름을 가진 구현체를 찾아서 사용한다.

```java
public interface MemberRepository
        extends JpaRepository<Member, Long>, MemberRepositoryCustom {
}
```

이제 다음과 같이 커스텀한 메서드를 호출할 수 있다.

```java
List<Member> result = memberRepository.findMemberCustom();
```

만약 뒤에 Impl을 붙이는 규칙을 변경하고 싶다면 다음과 같이 xml이나 javaConfig에서 설정을 변경하면 된다.  
하지만 가능하면 관례를 따라서 Impl을 붙이는게 유지 보수 괸점에서 좋다.

```xml
<repositories base-package="study.datajpa.repository"
               repository-impl-postfix="Impl" />
```

```java
@EnableJpaRepositories(
    basePackages = "study.datajpa.repository",
    repositoryImplementationPostfix = "Impl"
)
```

추가로, 스프링 데이터 2.x 부터는 커스텀 인터페이스의 이름 뒤에 Impl을 붙여도 스프링 데이터 JPA에서 적절히 구현체를 연결해준다.  
이 방법이 더 직관적이고, 여러 인터페이스를 동시에 사용할 수도 있기 때문에 권장한다.

```java
@RequiredArgsConstructor
public class MemberRepositoryCustomImpl implements MemberRepositoryCustom {
    ...
}
```

다만 반드시 하나의 레포지토리에 모든 데이터 접근 메서드를 넣어야 하는지에 대해서는 고민해 볼 필요가 있다.  
단순히 뷰를 뿌리는데 필요한 복잡한 동적 쿼리들과, 핵심적인 비즈니스 로직들은 별도의 레포지토리에 구현되는게 낫다.  
이렇게 해야 각 상황에서 어떤 메서드를 사용해야 하는지를 명확히 알 수 있다.

### Auditing

서비스 운영 관점에서 데이터베이스 테이블에 등록일, 수정일, 등록자, 수정자 등의 정보가 포함되어 있어야 관리가 용이하다.  
하지만 이를 직접 넣으려면 정보를 삽입하는 로직이 각 메서드에 번잡하게 추가되어야 하고, 일부 데이터에는 누락될 위험도 있다.

```java
package study.datajpa.entity;

@MappedSuperclass
@Getter
public class JpaBaseEntity {

    @Column(updatable = false)
    private LocalDateTime createdDate;
    private LocalDateTime updatedDate;

    @PrePersist
    public void prePersist() {
        LocalDateTime now = LocalDateTime.now();
        createdDate = now;
        updatedDate = now;
    }

    @PreUpdate
    public void preUpdate() {
        updatedDate = LocalDateTime.now();
    }
}
```

```java
public class Member extends JpaBaseEntity {}
```

```java
@Test
public void jpaEventBaseEntity() throws Exception {
    //given
    Member member = new Member("member1");
    memberRepository.save(member); //@PrePersist

    Thread.sleep(100);
    member.setUsername("member2");

    em.flush(); //@PreUpdate
    em.clear();

    //when
    Member findMember = memberRepository.findById(member.getId()).get();

    //then
    System.out.println("findMember.createdDate = " + findMember.getCreatedDate());
    System.out.println("findMember.updatedDate = " + findMember.getUpdatedDate());
}
```

```java
package study.datajpa.entity;

@EntityListeners(AuditingEntityListener.class)
@MappedSuperclass
@Getter
public class BaseEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;

}
```

```java
package jpabook.jpashop.domain;

@EntityListeners(AuditingEntityListener.class)
@MappedSuperclass
public class BaseEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;

    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String lastModifiedBy;

}
```

```java
@EnableJpaAuditing
@SpringBootApplication
public class DataJpaApplication {

    public static void main(String[] args) {
        SpringApplication.run(DataJpaApplication.class, args);
    }

    @Bean
    public AuditorAware<String> auditorProvider() {
        return () -> Optional.of(UUID.randomUUID().toString());
    }
}
```

```java
public class BaseTimeEntity {
    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdDate;

    @LastModifiedDate
    private LocalDateTime lastModifiedDate;
}

public class BaseEntity extends BaseTimeEntity {
    @CreatedBy
    @Column(updatable = false)
    private String createdBy;

    @LastModifiedBy
    private String lastModifiedBy;
}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings xmlns="http://xmlns.jcp.org/xml/ns/persistence/orm"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence/orm
 http://xmlns.jcp.org/xml/ns/persistence/orm_2_2.xsd"
                  version="2.2">

    <persistence-unit-metadata>
        <persistence-unit-defaults>
            <entity-listeners>
                <entity-listener
class="org.springframework.data.jpa.domain.support.AuditingEntityListener"/>
            </entity-listeners>
        </persistence-unit-defaults>
    </persistence-unit-metadata>
</entity-mappings>
```

### Web 확장 - 도메인 클래스 컨버터

```java
@RestController
@RequiredArgsConstructor
public class MemberController {

    private final MemberRepository memberRepository;

    @GetMapping("/members/{id}")
    public String findMember(@PathVariable("id") Long id) {
        Member member = memberRepository.findById(id).get();
        return member.getUsername();
    }
}
```

```java
@RestController
@RequiredArgsConstructor
public class MemberController {

    private final MemberRepository memberRepository;

    @GetMapping("/members/{id}")
    public String findMember(@PathVariable("id") Member member) {
        return member.getUsername();
    }
}
```

### Web 확장 - 페이징과 정렬

```java
@GetMapping("/members")
public Page<Member> list(Pageable pageable) {
    Page<Member> page = memberRepository.findAll(pageable);
    return page;
}
```

```groovy
spring.data.web.pageable.default-page-size=20 /# 기본 페이지 사이즈/
spring.data.web.pageable.max-page-size=2000 /# 최대 페이지 사이즈/
```

```java
@RequestMapping(value = "/members_page", method = RequestMethod.GET)
public String list(
    @PageableDefault(
        size = 12,
        sort = "username",
        direction = Sort.Direction.DESC
    )
    Pageable pageable
) {
    ...
}
```

```java
public String list(
    @Qualifier("member") Pageable memberPageable,
    @Qualifier("order") Pageable orderPageable,
    ...
)
```

```java
@Data
public class MemberDto {
    private Long id;
    private String username;

    public MemberDto(Member m) {
        this.id = m.getId();
        this.username = m.getUsername();
    }
}
```

```java
@GetMapping("/members")
public Page<MemberDto> list(Pageable pageable) {
    Page<Member> page = memberRepository.findAll(pageable);
    Page<MemberDto> pageDto = page.map(MemberDto::new);
    return pageDto;
}
```

```java
@GetMapping("/members")
public Page<MemberDto> list(Pageable pageable) {
    return memberRepository.findAll(pageable).map(MemberDto::new);
}
```

```json
{
    "content": [
        ...
    ],
    "pageable": {
        "offset": 0,
        "pageSize": 10,
        "pageNumber": 0 // 0 인덱스
    },
    "number": 0, // 0 인덱스
    "empty": false
}
```
